rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Is the user a participant in a document (e.g., reservation, chat)?
    function isParticipant(doc) {
      return request.auth.uid in doc.data.participantIds;
    }

    // Checks if a list query for chats is securely filtered.
    function isQueryingOwnChats() {
        return 'where' in request.query &&
               request.query.where.filter(w => 
                   w[0] == 'participantIds' && w[1] == 'array-contains' && w[2] == request.auth.uid
               ).size() > 0;
    }

    // Rules for User Profiles
    // Users can read and write their own profile, but cannot list all users.
    match /users/{userId} {
      allow read, update, delete: if isOwner(userId);
      allow create: if isSignedIn() && request.resource.data.uid == userId;
      allow list: if false; // Prevent listing all users for privacy
    }

    // Rules for Tents and their subcollections
    // Anyone can read tent data, but only the owner can write.
    match /tents/{tentId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      // Owners can update or delete their own tent document
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.ownerId;
      
      // Helper function to check if the current user owns the parent tent.
      function isTentOwner() {
        return exists(/databases/$(database)/documents/tents/$(tentId)) &&
               get(/databases/$(database)/documents/tents/$(tentId)).data.ownerId == request.auth.uid;
      }

      // Menu items inherit permissions from the parent tent.
      match /menuItems/{menuItemId} {
        allow get, list: if true;
        allow create, update, delete: if isSignedIn() && isTentOwner();
      }
      
      // Rental items inherit permissions from the parent tent.
      match /rentalItems/{rentalItemId} {
        allow get, list: if true;
        allow create, update, delete: if isSignedIn() && isTentOwner();
      }
    }

    // Rules for Reservations
    // Only participants (customer and tent owner) can access a reservation.
    match /reservations/{reservationId} {
      allow get, update: if isSignedIn() && isParticipant(resource);
      allow list: if isSignedIn() &&
                     'where' in request.query && (
                       request.query.where.filter(w => w[0] == 'userId' && w[1] == '==' && w[2] == request.auth.uid).size() > 0 ||
                       request.query.where.filter(w => w[0] == 'tentOwnerId' && w[1] == '==' && w[2] == request.auth.uid).size() > 0
                     );
      allow create: if isSignedIn() && isParticipant(request.resource);
      // For simplicity, we are allowing any participant to update. Deletion is disabled.
      allow delete: if false; // Prevent accidental deletion. Status should be updated to 'cancelled'.
    }
    
    // Rules for Chats
    // Only participants (customer and tent owner) can access a chat and its messages.
    match /chats/{chatId} {
      allow read, update: if isSignedIn() && isParticipant(resource);
      allow create: if isSignedIn() && isParticipant(request.resource);
      allow list: if isSignedIn() && isQueryingOwnChats();
      
      match /messages/{messageId} {
        allow read, create: if isSignedIn() && isParticipant(get(/databases/$(database)/documents/chats/$(chatId)));
        allow update, delete: if false; // Messages are immutable
      }
    }
  }
}
