rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // USERS: Users can create an account, but only read/write their own profile.
    match /users/{userId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth != null && request.auth.uid == userId;
    }

    // TENTS COLLECTION: Rules for listing and creating tents.
    match /tents {
      // Anyone can list tents to see them on the map/list.
      allow list: if true;
      // An authenticated user can create a tent if they are the owner.
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
    }

    // TENT DOCUMENT: Rules for a single tent and its subcollections.
    match /tents/{tentId} {
      // Anyone can get the details of a single tent.
      allow get: if true;
      // Only the tent owner can update or delete it.
      allow update, delete: if request.auth != null && get(/databases/$(database)/documents/tents/$(tentId)).data.ownerId == request.auth.uid;

      // MENU ITEMS: Anyone can read, only the owner can write.
      match /menuItems/{menuItemId} {
        allow read: if true;
        allow write: if get(/databases/$(database)/documents/tents/$(tentId)).data.ownerId == request.auth.uid;
      }
      
      // RENTAL ITEMS: Anyone can read, only the owner can write.
      match /rentalItems/{rentalItemId} {
        allow read: if true;
        allow write: if get(/databases/$(database)/documents/tents/$(tentId)).data.ownerId == request.auth.uid;
      }
    }

    // RESERVATIONS: Authenticated users can create. Only participants can read/update.
    match /reservations/{reservationId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth != null && request.auth.uid in resource.data.participantIds;
    }

    // CHATS: Authenticated users can create. Only participants can read/update.
    match /chats/{chatId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth != null && request.auth.uid in resource.data.participantIds;

      // MESSAGES: Participants can read messages. Senders can create them.
      match /messages/{messageId} {
        allow read: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds;
        allow create: if request.auth != null && request.resource.data.senderId == request.auth.uid;
      }
    }
  }
}
