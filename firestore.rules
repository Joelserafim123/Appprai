rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Is the user a participant in a document (e.g., reservation, chat)?
    // This is robust: checks for key existence, list type, and membership.
    function isParticipant(doc) {
      return 'participantIds' in doc.data &&
             doc.data.participantIds is list &&
             request.auth.uid in doc.data.participantIds;
    }

    function isCpfUnchanged() {
      // If cpf is not in the incoming data, it's not being changed.
      if (!('cpf' in request.resource.data)) {
        return true;
      }
      // If it is in the incoming data, check if it's the same as the existing one.
      // If the existing one doesn't exist, this will be false, which is correct (it's a change).
      return 'cpf' in resource.data && request.resource.data.cpf == resource.data.cpf;
    }

    function isNewCpfUnique(newCpf) {
      // Checks that a document for the new CPF doesn't already exist.
      return !exists(/databases/$(database)/documents/cpfs/$(newCpf));
    }

    // Rules for User Profiles
    // Users can read and write their own profile, but cannot list all users.
    match /users/{userId} {
      allow read, delete: if isOwner(userId);
      allow create: if isSignedIn() && request.resource.data.uid == userId;
      // An update is allowed if the user is the owner, AND
      // either the CPF is not being changed, OR the new CPF is unique.
      allow update: if isOwner(userId) && (isCpfUnchanged() || isNewCpfUnique(request.resource.data.cpf));
      allow list: if false; // Prevent listing all users for privacy
    }

    // Rules for CPFs (to enforce uniqueness)
    match /cpfs/{cpf} {
      // Allow any signed-in user to check if a CPF exists for client-side validation.
      allow get: if isSignedIn();
      allow list: if false; // Do not allow listing all CPFs.
      // Allow creation only if the document doesn't exist (implicit in create)
      // and the creator is the one associated with the CPF being written in the user profile document as part of a batch write.
      allow create: if isSignedIn() && 
                     request.resource.data.userId == request.auth.uid &&
                     getAfter(/databases/$(database)/documents/users/$(request.auth.uid)).data.cpf == cpf;
      // Allow deletion only by the owner of the CPF record.
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      // Updates are not allowed. Must delete and create.
      allow update: if false;
    }

    // Rules for Tents and their subcollections
    // Anyone can read tent data, but only the owner can write.
    match /tents/{tentId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      // Owners can update or delete their own tent document
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.ownerId;
      
      // Helper function to check if the current user owns the parent tent.
      function isTentOwner() {
        return exists(/databases/$(database)/documents/tents/$(tentId)) &&
               get(/databases/$(database)/documents/tents/$(tentId)).data.ownerId == request.auth.uid;
      }

      // Menu items inherit permissions from the parent tent.
      match /menuItems/{menuItemId} {
        allow get, list: if true;
        allow create, update, delete: if isSignedIn() && isTentOwner();
      }
      
      // Rental items inherit permissions from the parent tent.
      match /rentalItems/{rentalItemId} {
        allow get, list: if true;
        allow create, update, delete: if isSignedIn() && isTentOwner();
      }

      // Reviews for a tent
      match /reviews/{reviewId} {
        // Anyone can read reviews
        allow get, list: if true;

        // Only a signed-in user who made the reservation can create a review for it, once.
        allow create: if isSignedIn() &&
                         request.resource.data.userId == request.auth.uid &&
                         exists(/databases/$(database)/documents/reservations/$(request.resource.data.reservationId)) &&
                         get(/databases/$(database)/documents/reservations/$(request.resource.data.reservationId)).data.userId == request.auth.uid &&
                         get(/databases/$(database)/documents/reservations/$(request.resource.data.reservationId)).data.tentId == tentId &&
                         get(/databases/$(database)/documents/reservations/$(request.resource.data.reservationId)).data.status == 'completed' &&
                         get(/databases/$(database)/documents/reservations/$(request.resource.data.reservationId)).data.reviewed != true;

        // Users cannot update or delete reviews for simplicity
        allow update, delete: if false;
      }
    }

    // Rules for Reservations
    // Only participants (customer and tent owner) can access a reservation.
    match /reservations/{reservationId} {
      allow get, update: if isSignedIn() && isParticipant(resource);
      allow list: if isSignedIn() &&
                     (request.query.get('userId') == request.auth.uid ||
                      request.query.get('tentOwnerId') == request.auth.uid);
      allow create: if isSignedIn() && isParticipant(request.resource);
      // For simplicity, we are allowing any participant to update. Deletion is disabled.
      allow delete: if false; // Prevent accidental deletion. Status should be updated to 'cancelled'.
    }
    
    // Rules for Chats
    match /chats/{chatId} {
      // This rule allows a query to proceed if the user is authenticated.
      // The results are then secured by the 'get' rule, which checks for participation.
      allow list: if isSignedIn();
      
      // A user can read or update a chat document if they are a participant.
      allow get, update: if isSignedIn() && isParticipant(resource);
      
      // A user can create a chat if they are a participant in the new chat document.
      allow create: if isSignedIn() && isParticipant(request.resource);
      
      // Deleting chats is not allowed for data integrity.
      allow delete: if false;

      match /messages/{messageId} {
        // Participants of the parent chat can read and create messages.
        allow read, create: if isSignedIn() && isParticipant(get(/databases/$(database)/documents/chats/$(chatId)));
        // Messages are immutable.
        allow update, delete: if false;
      }
    }
  }
}
