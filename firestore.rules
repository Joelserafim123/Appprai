rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- BARRACAS (TENTS) ---
    // Regra #1A: Permitir que qualquer pessoa LISTE a coleção de barracas.
    // Isto é necessário para exibir as barracas no mapa/lista pública.
    match /tents {
      allow list: if true;
    }

    // Regra #1B: Permitir que qualquer pessoa LEIA (get) os dados de uma barraca individual.
    // Regra #2: Permitir que apenas o dono da barraca ESCREVA (crie, atualize, apague) na sua barraca.
    match /tents/{tentId} {
      allow get: if true;
      allow write: if request.auth != null && request.auth.uid == tentId;

      // Regras para sub-coleções de barracas (Cardápio e Itens de Aluguel)
      match /menuItems/{menuItemId} {
        allow read: if true; // `read` permite `get` e `list` para o cardápio da barraca
        allow write: if request.auth != null && request.auth.uid == tentId;
      }
      match /rentalItems/{rentalItemId} {
        allow read: if true; // `read` permite `get` e `list` para os itens de aluguel da barraca
        allow write: if request.auth != null && request.auth.uid == tentId;
      }
    }

    // Regra #3: Perfis de Utilizador
    match /users/{userId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth != null && request.auth.uid == userId;
    }

    // Regra #4: Reservas
    match /reservations/{reservationId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow read: if request.auth != null && (request.auth.uid == resource.data.userId || request.auth.uid == resource.data.tentOwnerId);
      allow update: if request.auth != null && request.auth.uid in resource.data.participantIds;
    }
    
    // Regra #5: Chats
    match /chats/{chatId} {
      allow read, create, update: if request.auth != null && request.auth.uid in resource.data.participantIds;
      
      match /messages/{messageId} {
        allow read, create: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds;
      }
    }
  }
}
