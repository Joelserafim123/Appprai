rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Tents are publicly readable.
    match /tents/{tentId} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      allow delete: if request.auth != null && resource.data.ownerId == request.auth.uid;
      
      // Update rule for tents
      allow update: if request.auth != null && (
        // The owner can update their tent.
        resource.data.ownerId == request.auth.uid ||
        // A customer can update rating fields when submitting a review.
        // This is less secure than a Cloud Function but is required for client-side aggregation.
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['averageRating', 'reviewCount']) &&
          request.resource.data.reviewCount == resource.data.reviewCount + 1
        )
      );
    }
    
    // Tent subcollections
    match /tents/{tentId}/{subcollection}/{docId} {
        // Menu and rental items are publicly readable.
        allow read: if true;
        // Owners can manage their menu and rental items.
        allow write: if (subcollection == 'menuItems' || subcollection == 'rentalItems')
                      && request.auth != null 
                      && get(/databases/$(database)/documents/tents/$(tentId)).data.ownerId == request.auth.uid;
        // Users can create reviews, but not update/delete them.
        allow create: if subcollection == 'reviews'
                       && request.auth != null
                       && request.resource.data.userId == request.auth.uid;
    }

    // User profiles can only be read/written by the user themselves.
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // CPF documents are used for uniqueness checks.
    match /cpfs/{cpf} {
      // Allow any authenticated user to check if a CPF exists.
      allow get: if request.auth != null;
      // Allow a user to create a CPF document for themselves.
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      // Prevent listing all CPFs or modifying/deleting them.
      allow list, update, delete: if false;
    }

    // Reservations can be created by users, and read/updated by participants.
    match /reservations/{reservationId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow read: if request.auth != null && request.auth.uid in resource.data.participantIds;
      allow update: if request.auth != null && (
        // The owner of the tent can always update the reservation
        (request.auth.uid == resource.data.tentOwnerId) ||
        // The user who created the reservation can update it under specific conditions
        (request.auth.uid == resource.data.userId && (
            // 1. To cancel a confirmed reservation
            (request.resource.data.status == 'cancelled' && resource.data.status == 'confirmed') ||
            // 2. To add items to a checked-in reservation
            (resource.data.status == 'checked-in' && request.resource.data.status == 'checked-in') ||
            // 3. To mark a completed reservation as reviewed
            (
                resource.data.status == 'completed' &&
                (!('reviewed' in resource.data) || resource.data.reviewed == false) &&
                request.resource.data.reviewed == true &&
                request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reviewed'])
            )
        ))
      );
    }

    // Chats and messages can be managed by participants.
    match /chats/{chatId} {
      allow create: if request.auth != null && request.auth.uid in request.resource.data.participantIds;
      allow read, update: if request.auth != null && request.auth.uid in resource.data.participantIds;

      match /messages/{messageId} {
        allow read: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds;
        // Allow a participant to create a message as themselves or as the 'system'.
        allow create: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds
                      && (request.resource.data.senderId == request.auth.uid || request.resource.data.senderId == 'system');
        allow update, delete: if false;
      }
    }
  }
}
